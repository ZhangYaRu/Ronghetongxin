package com.zhbd.beidoucommunication.db;

import android.content.ContentValues;
import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;

import com.zhbd.beidoucommunication.MyApplication;
import com.zhbd.beidoucommunication.config.Constants;
import com.zhbd.beidoucommunication.domain.CommonMessage;
import com.zhbd.beidoucommunication.domain.EmailMessage;
import com.zhbd.beidoucommunication.domain.Friend;
import com.zhbd.beidoucommunication.domain.GroupMessage;
import com.zhbd.beidoucommunication.domain.SmsMessage;
import com.zhbd.beidoucommunication.domain.User;

import java.util.ArrayList;

/**
 * Created by Administrator on 2017/7/29.
 */

public class DatabaseDao {
    private DatabaseHelper mMyDBHelper;
    private SQLiteDatabase db;
    /**
     * 消息表
     */
    private final String tab_common_message_name = "message";
    /**
     * 群组消息表
     */
    private final String tab_group_message_name = "group_message";
    /**
     * ic卡表
     */
    private final String tab_icinfo_name = "icinfo";
    /**
     * 群租表
     */
    private final String tab_group_name = "my_group";
    /**
     * 联系人表
     */
    private final String tab_friends_name = "friends";

    /**
     * 短信信息表
     */
    private final String tab_sms_name = "sms";

    /**
     * 邮件表
     */
    private final String tab_email_name = "tab_email";

    /**
     * 用户表
     */
    private final String tab_user_name = "user";


    private DatabaseDao(Context context, int userId) {
        mMyDBHelper = new DatabaseHelper(context, userId);
    }

    private static DatabaseDao dao;

    /**
     * 获取到实例
     *
     * @param context
     * @return
     */
    public static synchronized DatabaseDao getInstance(Context context, int userId) {
        if (dao == null) {
            dao = new DatabaseDao(context, userId);
        }
        return dao;
    }

    /**
     * 为用户表表添加一条信息
     *
     * @param user
     * @return 是否添加成功
     */
    public boolean addDateToUser(User user) {
        db = mMyDBHelper.getWritableDatabase();
        ContentValues values = new ContentValues();
        values.put("user_id", user.getUserId());
        values.put("nick_name", user.getNickName());
        values.put("phone_number", user.getPhoneNumber());
        values.put("ic_card_number", user.getIdCardNumber());
        values.put("password", user.getPassWord());
        long rowid = db.insert(tab_user_name, null, values);
        if (rowid >= 0) {
            return true;
        } else {
            return false;
        }
    }


    /**
     * 向消息表中添加一条数据
     *
     * @param msg
     * @return 是否添加成功
     */
    public boolean addDataToMessage(CommonMessage msg) {
        //Log.e("rowid","调用了数据库添加方法");
        // 增删改查每一个方法都要得到数据库，然后操作完成后一定要关闭
        // getWritableDatabase(); 执行后数据库文件才会生成
        // 数据库文件利用DDMS可以查看，在 data/data/包名/databases 目录下即可查看
        db = mMyDBHelper.getWritableDatabase();
        ContentValues values = new ContentValues();
        values.put("sender_name", msg.getSenderName());
        values.put("sender_number", msg.getSenderNumber());
        values.put("content", msg.getContent());
        values.put("second", msg.getSecond());
        values.put("time", msg.getTime());
        values.put("state", msg.getStatus());
        values.put("type", msg.getType());
        values.put("is_read", msg.getIsRead());
        // 返回,显示数据添加在第几行
        // 加了现在连续添加了3行数据,突然删掉第三行,然后再添加一条数据返回的是4不是3
        // 因为自增长
        long rowid = db.insert(tab_common_message_name, null, values);
        // 得到自己字段的id值,不用系统的行号
        int _id = dao.queryIdByUserId(msg.getSenderNumber());
        // 发送广播
        Intent intent = new Intent(Constants.RECEIVE_ROWID_ACTION);
        intent.putExtra("rowid", _id);
        MyApplication.getContextObject().sendBroadcast(intent);
        if (rowid >= 0) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * 向短信表中添加一条数据
     *
     * @param msg
     * @return 是否添加成功
     */
    public boolean addDataToSms(SmsMessage msg) {
        db = mMyDBHelper.getWritableDatabase();
        ContentValues values = new ContentValues();
        values.put("name", msg.getSenderName());
        values.put("phone_number", msg.getPhoneNumber());
        values.put("content", msg.getContent());
        values.put("send_time", msg.getTime());
        values.put("state", msg.getStatus());
        values.put("read_state", msg.getIsRead());
        // 返回,显示数据添加在第几行
        // 加了现在连续添加了3行数据,突然删掉第三行,然后再添加一条数据返回的是4不是3
        // 因为自增长
        long rowid = db.insert(tab_sms_name, null, values);
        if (rowid >= 0) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * 向邮件表中添加一条数据
     *
     * @param email
     * @return 是否添加成功
     */
    public boolean addDataToEmail(EmailMessage email) {
        db = mMyDBHelper.getWritableDatabase();
        ContentValues values = new ContentValues();
        values.put("address", email.getAddress());
        values.put("content", email.getContent());
        values.put("send_time", email.getSendTime());
        // 返回,显示数据添加在第几行
        // 加了现在连续添加了3行数据,突然删掉第三行,然后再添加一条数据返回的是4不是3
        // 因为自增长
        long rowid = db.insert(tab_email_name, null, values);
        if (rowid >= 0) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * 根据发送号码, 查找对应_id
     *
     * @param senderNumber 发送者id
     * @return
     */
    private int queryIdByUserId(int senderNumber) {
        db = mMyDBHelper.getReadableDatabase();
        Cursor cursor = db.rawQuery("SELECT _id FROM " + tab_common_message_name
                + " where sender_number=?", new String[]{String.valueOf(senderNumber)});
        int _id = 0;
        if (cursor != null) {
            if (cursor.moveToNext()) {
                _id = cursor.getInt(cursor.getColumnIndex("_id"));
            }
        }
        cursor.close();
        return _id;
    }

    /**
     * 根据ic卡号删除某用户的所有消息记录
     *
     * @param icNumber ic号码
     * @return 是否删除成功
     */

    public boolean delDataforMsgInfoByIcNumber(int icNumber) {
        db = mMyDBHelper.getWritableDatabase();
        int delete = db.delete(tab_common_message_name, "sender_number=?", new String[]{icNumber + ""});
        if (delete == 0) {
            return false;
        } else {
            return true;
        }
    }


    /**
     * 查询消息数据库中去除重复的消息
     *
     * @return
     */
    public ArrayList<CommonMessage> queryMessageDistinct() {
        db = mMyDBHelper.getReadableDatabase();
        Cursor cursor = db.query(true, tab_common_message_name, null, null, null, "sender_number", null, null, null);
        ArrayList<CommonMessage> messages = new ArrayList<>();
        if (cursor != null) {
            while (cursor.moveToNext()) {
                CommonMessage msg = new CommonMessage();
                msg.set_id(cursor.getInt(cursor.getColumnIndex("_id")));
                msg.setSenderNumber(cursor.getInt(cursor.getColumnIndex("sender_number")));
                msg.setSenderName(cursor.getString(cursor.getColumnIndex("sender_name")));
                msg.setContent(cursor.getString(cursor.getColumnIndex("content")));
                msg.setTime(cursor.getString(cursor.getColumnIndex("time")));
                msg.setSecond(cursor.getInt(cursor.getColumnIndex("second")));
                msg.setStatus(cursor.getInt(cursor.getColumnIndex("state")));
                msg.setType(cursor.getInt(cursor.getColumnIndex("type")));
                msg.setIsRead(cursor.getInt(cursor.getColumnIndex("is_read")));
                messages.add(msg);
            }
        }
        cursor.close();
        return messages;
    }


    /**
     * 查询消息数据库中去除重复的短信消息
     *
     * @return
     */
    public ArrayList<SmsMessage> querySmsDistinct() {
        db = mMyDBHelper.getReadableDatabase();
        Cursor cursor = db.query(true, tab_sms_name, null, null, null, "phone_number", null, null, null);
        ArrayList<SmsMessage> messages = new ArrayList<>();
        if (cursor != null) {
            while (cursor.moveToNext()) {
                SmsMessage msg = new SmsMessage();
                msg.set_id(cursor.getInt(cursor.getColumnIndex("_id")));
                msg.setPhoneNumber(cursor.getString(cursor.getColumnIndex("phone_number")));
                msg.setSenderName(cursor.getString(cursor.getColumnIndex("name")));
                msg.setContent(cursor.getString(cursor.getColumnIndex("content")));
                msg.setTime(cursor.getString(cursor.getColumnIndex("send_time")));
                msg.setStatus(cursor.getInt(cursor.getColumnIndex("state")));
                msg.setIsRead(cursor.getInt(cursor.getColumnIndex("read_state")));
                messages.add(msg);
            }
        }
        cursor.close();
        return messages;
    }

    /**
     * 去重复查询邮件
     *
     * @return
     */
    public ArrayList<EmailMessage> queryEmail() {
        db = mMyDBHelper.getReadableDatabase();
        Cursor cursor = db.query(true, tab_email_name, null, null, null, null, null, null, null);
        ArrayList<EmailMessage> emailList = new ArrayList<>();
        if (cursor != null) {
            while (cursor.moveToNext()) {
                EmailMessage email = new EmailMessage();
                email.set_id(cursor.getInt(cursor.getColumnIndex("_id")));
                email.setAddress(cursor.getString(cursor.getColumnIndex("address")));
                email.setContent(cursor.getString(cursor.getColumnIndex("content")));
                email.setSendTime(cursor.getString(cursor.getColumnIndex("send_time")));
                emailList.add(email);
            }
        }
        cursor.close();
        return emailList;
    }

    /**
     * 查询所有好友信息
     *
     * @return 查询到的所有好友信息
     */
    public ArrayList<Friend> queryFriensInfo() {
        db = mMyDBHelper.getReadableDatabase();
        ArrayList<Friend> friends = new ArrayList<>();
        Cursor cursor = db.rawQuery("SELECT * FROM " + tab_friends_name, null);
        if (cursor != null) {
            while (cursor.moveToNext()) {
                Friend friend = new Friend();
                friend.set_id(cursor.getInt(cursor.getColumnIndex("_id")));
                friend.setName(cursor.getString(cursor.getColumnIndex("name")));
                friend.setUserId(cursor.getInt(cursor.getColumnIndex("user_id")));
                friend.setPhoneNumber(cursor.getString(cursor.getColumnIndex("phone_number")));
                friend.setIdCard(cursor.getString(cursor.getColumnIndex("id_card")));
                friend.setSimNumber(cursor.getString(cursor.getColumnIndex("sim_number")));
                friends.add(friend);
            }
        }
        cursor.close(); // 记得关闭 corsor
        return friends;
    }


    public ArrayList<GroupMessage> queryGroupMessageByGroupId(int GroupId) {

        return null;
    }

    /**
     * 根据用户ID查找对应者的全部消息
     *
     * @param userId
     * @return
     */
    public ArrayList<CommonMessage> queryCommonMessageByUserId(int userId) {
        db = mMyDBHelper.getReadableDatabase();
        Cursor cursor = db.rawQuery("SELECT * FROM " + tab_common_message_name
                + " where sender_number=?", new String[]{String.valueOf(userId)});
        ArrayList<CommonMessage> messages = new ArrayList<>();
        if (cursor != null) {
            while (cursor.moveToNext()) {
                CommonMessage msg = new CommonMessage();
                msg.set_id(cursor.getInt(cursor.getColumnIndex("_id")));
                msg.setSenderNumber(cursor.getInt(cursor.getColumnIndex("sender_number")));
                msg.setSenderName(cursor.getString(cursor.getColumnIndex("sender_name")));
                msg.setContent(cursor.getString(cursor.getColumnIndex("content")));
                msg.setTime(cursor.getString(cursor.getColumnIndex("time")));
                msg.setSecond(cursor.getInt(cursor.getColumnIndex("second")));
                msg.setStatus(cursor.getInt(cursor.getColumnIndex("state")));
                msg.setType(cursor.getInt(cursor.getColumnIndex("type")));
                msg.setIsRead(cursor.getInt(cursor.getColumnIndex("is_read")));
                messages.add(msg);
            }
        }
        cursor.close();
        return messages;
    }

    /**
     * 根据手机号查找对应的短信消息
     *
     * @param phoneNumber 手机号
     * @return
     */
    public ArrayList<SmsMessage> querySmsByPhoneNumber(String phoneNumber) {
        db = mMyDBHelper.getReadableDatabase();
        Cursor cursor = db.rawQuery("SELECT * FROM " + tab_sms_name
                + " where phone_number=?", new String[]{phoneNumber});
        ArrayList<SmsMessage> messages = new ArrayList<>();
        if (cursor != null) {
            while (cursor.moveToNext()) {
                SmsMessage msg = new SmsMessage();
                msg.set_id(cursor.getInt(cursor.getColumnIndex("_id")));
                msg.setPhoneNumber(cursor.getString(cursor.getColumnIndex("phone_number")));
                msg.setSenderName(cursor.getString(cursor.getColumnIndex("name")));
                msg.setContent(cursor.getString(cursor.getColumnIndex("content")));
                msg.setTime(cursor.getString(cursor.getColumnIndex("send_time")));
                msg.setStatus(cursor.getInt(cursor.getColumnIndex("state")));
                msg.setIsRead(cursor.getInt(cursor.getColumnIndex("read_state")));
                messages.add(msg);
            }
        }
        cursor.close();
        return messages;
    }

    /**
     * 根据userid查询用户其他信息
     *
     * @param userId
     * @return
     */
    public User queryUserInfoByUserId(int userId) {
        db = mMyDBHelper.getReadableDatabase();
        Cursor cursor = db.rawQuery("SELECT * FROM " + tab_user_name
                + " where user_id=?", new String[]{String.valueOf(userId)});
        User user = null;
        if (cursor.moveToNext()) {
            user = new User();
            user.setUserId(userId);
            user.setPassWord(cursor.getString(cursor.getColumnIndex("password")));
            user.setPhoneNumber(cursor.getString(cursor.getColumnIndex("phone_number")));
            user.setIdCardNumber(cursor.getString(cursor.getColumnIndex("id_card_number")));
            user.setNickName(cursor.getString(cursor.getColumnIndex("nick_name")));
        }
        cursor.close();
        return user;
    }

    /**
     * 根据行_id改变消息的发送状态
     *
     * @param _id       行号
     * @param sendState 发送状态
     * @return 收到改变的行数
     */
    public int updateStateByRowId(int _id, byte sendState) {
        db = mMyDBHelper.getWritableDatabase();
        ContentValues values = new ContentValues();
        values.put("state", sendState);
        int updateResult = db.update(tab_common_message_name, values, "_id=?",
                new String[]{String.valueOf(_id)});
        return updateResult;
    }


    /**
     * 关闭数据库的方法
     */
    public void close() {
        if (db != null)
            db.close();
    }

}
